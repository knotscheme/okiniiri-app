{%- comment -%} 
  å•†å“ãƒšãƒ¼ã‚¸ç”¨: ãŠæ°—ã«å…¥ã‚Šï¼†é€šçŸ¥ãƒœã‚¿ãƒ³ (wishlist-trigger.liquid)
  â˜…çµ±åˆç‰ˆ: å¤šè¨€èªã‚¹ãƒãƒ¼ãƒˆåˆ¤å®šç¶­æŒ ï¼‹ çˆ†é€Ÿãƒˆãƒ¼ã‚¹ãƒˆé€šçŸ¥ ï¼‹ æ¥½è¦³çš„UI
{%- endcomment -%}

{%- comment -%} --- è¨€èªè¨­å®šã®å–å¾— --- {%- endcomment -%}
{%- assign store_lang = request.locale.iso_code | slice: 0, 2 -%}
{%- assign app_setting_lang = shop.metafields.wishflow_settings.language.value -%}
{%- assign global_lang = app_setting_lang | default: store_lang | default: 'ja' -%}

{%- comment -%} --- åˆ¤å®šç”¨ï¼šãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã®å®šç¾© --- {%- endcomment -%}
{%- assign def_add_en = 'Add to Wishlist' -%}
{%- assign def_add_ja = 'ãŠæ°—ã«å…¥ã‚Šã«è¿½åŠ ' -%}
{%- assign def_added_en = 'In Wishlist' -%}
{%- assign def_added_ja = 'è¿½åŠ æ¸ˆã¿' -%}
{%- assign def_notify_en = 'Notify Me When Available' -%}
{%- assign def_notify_ja = 'å…¥è·é€šçŸ¥ã‚’å—ã‘å–ã‚‹' -%}
{%- assign def_subscribed_en = 'Notification Set' -%}
{%- assign def_subscribed_ja = 'å…¥è·é€šçŸ¥ç™»éŒ²æ¸ˆã¿' -%}
{%- assign def_submit_en = 'Register' -%}
{%- assign def_submit_ja = 'ç™»éŒ²ã™ã‚‹' -%}

{%- comment -%} ã‚¹ãƒãƒ¼ãƒˆåˆ¤å®šãƒ­ã‚¸ãƒƒã‚¯ {%- endcomment -%}
{%- assign val_add = block.settings.text_add -%}
{%- if val_add == blank or val_add == def_add_en or val_add == def_add_ja -%}
  {%- assign use_translation = true -%}
{%- else -%}
  {%- assign use_translation = false -%}
{%- endif -%}

{%- if use_translation -%}
  {%- case global_lang -%}
    {%- when 'zh', 'zh-TW' -%}
      {%- assign text_add = 'åŠ å…¥æ”¶è—' -%}
      {%- assign text_added = 'å·²æ”¶è—' -%}
      {%- assign text_notify = 'åˆ°è²¨é€šçŸ¥æˆ‘' -%}
      {%- assign text_subscribed = 'å·²è¨‚é–±é€šçŸ¥' -%}
      {%- assign text_email_label = 'è¼¸å…¥æ¥æ”¶é€šçŸ¥çš„é›»å­éƒµä»¶' -%}
      {%- assign text_email_placeholder = 'example@email.com' -%}
      {%- assign text_submit = 'æäº¤' -%}
      {%- assign text_close = 'é—œé–‰' -%}
      {%- assign text_success_notified = 'é€šçŸ¥å·²è¨­å®š' -%}
      {%- assign text_success_removed = 'é€šçŸ¥å·²å–æ¶ˆ' -%}
      {%- assign text_error_email = 'è«‹è¼¸å…¥æ­£ç¢ºçš„é›»å­éƒµä»¶åœ°å€' -%}
    {%- when 'en' -%}
      {%- assign text_add = 'Add to Wishlist' -%}
      {%- assign text_added = 'In Wishlist' -%}
      {%- assign text_notify = 'Notify Me When Available' -%}
      {%- assign text_subscribed = 'Notification Set' -%}
      {%- assign text_email_label = 'Enter email for restock alerts' -%}
      {%- assign text_email_placeholder = 'example@email.com' -%}
      {%- assign text_submit = 'Register' -%}
      {%- assign text_close = 'Close' -%}
      {%- assign text_success_notified = 'Notification Set' -%}
      {%- assign text_success_removed = 'Notification Canceled' -%}
      {%- assign text_error_email = 'Please enter a valid email address' -%}
    {%- when 'fr' -%}
      {%- assign text_add = 'Ajouter aux favoris' -%}
      {%- assign text_added = 'Dans les favoris' -%}
      {%- assign text_notify = "M'informer du rÃ©approvisionnement" -%}
      {%- assign text_subscribed = 'Notification configurÃ©e' -%}
      {%- assign text_submit = "S'inscrire" -%}
      {%- assign text_close = 'Fermer' -%}
      {%- assign text_success_notified = 'EnregistrÃ©' -%}
      {%- assign text_success_removed = 'SupprimÃ©' -%}
      {%- assign text_error_email = 'Email invalide' -%}
    {%- when 'de' -%}
      {%- assign text_add = 'Auf die Wunschliste' -%}
      {%- assign text_added = 'In der Wunschliste' -%}
      {%- assign text_notify = 'Benachrichtigen, wenn verfÃ¼gbar' -%}
      {%- assign text_subscribed = 'Benachrichtigung eingestellt' -%}
      {%- assign text_submit = 'Registrieren' -%}
      {%- assign text_close = 'SchlieÃŸen' -%}
      {%- assign text_success_notified = 'Gespeichert' -%}
      {%- assign text_success_removed = 'Entfernt' -%}
      {%- assign text_error_email = 'UngÃ¼ltige E-Mail' -%}
    {%- when 'es' -%}
      {%- assign text_add = 'AÃ±adir a deseos' -%}
      {%- assign text_added = 'En lista de deseos' -%}
      {%- assign text_notify = 'AvÃ­same cuando estÃ© disponible' -%}
      {%- assign text_subscribed = 'NotificaciÃ³n configurada' -%}
      {%- assign text_submit = 'Registrar' -%}
      {%- assign text_close = 'Cerrar' -%}
      {%- assign text_success_notified = 'Guardado' -%}
      {%- assign text_success_removed = 'Eliminado' -%}
      {%- assign text_error_email = 'Email invÃ¡lido' -%}
    {%- else -%}
      {%- assign text_add = 'ãŠæ°—ã«å…¥ã‚Šã«è¿½åŠ ' -%}
      {%- assign text_added = 'è¿½åŠ æ¸ˆã¿' -%}
      {%- assign text_notify = 'å…¥è·é€šçŸ¥ã‚’å—ã‘å–ã‚‹' -%}
      {%- assign text_subscribed = 'å…¥è·é€šçŸ¥ç™»éŒ²æ¸ˆã¿' -%}
      {%- assign text_email_label = 'å…¥è·é€šçŸ¥ã‚’å—ã‘å–ã‚‹ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å…¥åŠ›' -%}
      {%- assign text_email_placeholder = 'example@email.com' -%}
      {%- assign text_submit = 'ç™»éŒ²ã™ã‚‹' -%}
      {%- assign text_close = 'é–‰ã˜ã‚‹' -%}
      {%- assign text_success_notified = 'é€šçŸ¥ã‚’è¨­å®šã—ã¾ã—ãŸ' -%}
      {%- assign text_success_removed = 'é€šçŸ¥ã‚’è§£é™¤ã—ã¾ã—ãŸ' -%}
      {%- assign text_error_email = 'æ­£ã—ã„ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„' -%}
  {%- endcase -%}
{%- else -%}
  {%- assign text_add = block.settings.text_add -%}
  {%- assign text_added = block.settings.text_added -%}
  {%- assign text_notify = block.settings.text_notify -%}
  {%- assign text_subscribed = block.settings.text_subscribed -%}
  {%- assign text_email_label = block.settings.text_email_label -%}
  {%- assign text_email_placeholder = block.settings.text_email_placeholder -%}
  {%- assign text_submit = block.settings.text_submit -%}
  {%- assign text_close = block.settings.text_close -%}
  {%- assign text_success_notified = 'Saved' -%}
  {%- assign text_success_removed = 'Removed' -%}
  {%- assign text_error_email = 'Invalid email' -%}
{%- endif -%}

{%- assign modal_bg_color = block.settings.modal_bg_color | default: '#ffffff' -%}
{%- assign modal_opacity_decimal = block.settings.modal_bg_opacity | default: 85 | divided_by: 100.0 -%}
{%- assign modal_bg_rgba = modal_bg_color | color_modify: 'alpha', modal_opacity_decimal -%}

<div class="wishlist-app-container wishlist-app-container-{{ block.id }}" id="wishflow-root-{{ block.id }}">
  <button type="button" class="wishlist-button" id="wishlist-btn-{{ product.handle }}" onclick="event.stopPropagation(); window.toggleWishlist('{{ product.handle }}')">
    <span class="wishlist-icon">
      {% case block.settings.icon_type %}
        {% when 'outline_heart' %}<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path></svg>
        {% when 'solid_heart' %}<svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/></svg>
        {% when 'star' %}<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"></polygon></svg>
        {% when 'bookmark' %}<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 21l-7-5-7 5V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2z"></path></svg>
      {% endcase %}
    </span>
    <span class="wishlist-text" id="wishlist-text-{{ product.handle }}">{{ text_add }}</span>
  </button>
  <button id="notify-btn-{{ product.handle }}" class="notify-btn" style="display: none;" onclick="event.stopPropagation(); window.requestNotify('{{ product.handle }}')" type="button">{{ text_notify }}</button>
</div>

{%- comment -%} â˜…çˆ†é€Ÿãƒˆãƒ¼ã‚¹ãƒˆé€šçŸ¥ç”¨ã®å—ã‘çš¿ {%- endcomment -%}
<div id="wishflow-toast-trigger" class="wf-toast-hidden"></div>

<script type="application/json" id="wishlist-config-{{ block.id }}">
{
  "textEmailLabel": "{{ text_email_label | escape }}",
  "textEmailPlaceholder": "{{ text_email_placeholder | escape }}",
  "textSubmit": "{{ text_submit | escape }}",
  "textClose": "{{ text_close | escape }}",
  "textErrorEmail": "{{ text_error_email | escape }}",
  "modalBgRgba": "{{ modal_bg_rgba }}", 
  "modalText": "{{ block.settings.modal_text_color | default: '#121212' }}",
  "modalRadius": "{{ block.settings.modal_radius | default: 12 }}px",
  "modalGlass": {{ block.settings.modal_glass_effect | json }},
  "submitBg": "{{ block.settings.notify_bg_color | default: '#ffffff' }}",
  "submitText": "{{ block.settings.notify_text_color | default: '#d72c0d' }}",
  "submitBorderColor": "{{ block.settings.notify_border_color | default: '#d72c0d' }}",
  "submitBorderWidth": "1px",
  "submitRadius": "{{ block.settings.custom_border_radius | default: 4 }}px"
}
</script>

<script type="application/json" id="VariantData-{{ block.id }}">{{ product.variants | json }}</script>
<script type="application/json" id="DefaultVariant-{{ block.id }}">{{ product.selected_or_first_available_variant.id | json }}</script>

<style>
  .wishlist-app-container-{{ block.id }} {
    display: flex; flex-direction: column; gap: 10px; margin: 20px 0;
    --btn-bg: {{ block.settings.btn_bg_color }};
    --text-color: {{ block.settings.text_color }};
    --border-color: {{ block.settings.border_color }};
    --notify-bg: {{ block.settings.notify_bg_color }};
    --notify-text: {{ block.settings.notify_text_color }};
    --notify-border: {{ block.settings.notify_border_color }};
    --text-size: {{ block.settings.custom_text_size }}px;
    --text-weight: {{ block.settings.text_weight }};
    --border-width: {{ block.settings.custom_border_width }}px;
    --border-radius: {{ block.settings.custom_border_radius }}px;
    --btn-padding: {{ block.settings.custom_btn_padding }}px;
    --icon-size: {{ block.settings.custom_icon_size }}px;
    --icon-color: {{ block.settings.icon_color }};
  }
  .wishlist-app-container-{{ block.id }} .wishlist-button, 
  .wishlist-app-container-{{ block.id }} .notify-btn {
    display: flex; align-items: center; justify-content: center; gap: 8px; width: 100%;
    padding: var(--btn-padding) 12px; cursor: pointer; background: var(--btn-bg);
    color: var(--text-color); font-size: var(--text-size); font-weight: var(--text-weight);
    border: var(--border-width) solid var(--border-color); border-radius: var(--border-radius);
    transition: all 0.2s ease; box-sizing: border-box;
  }
  .wishlist-app-container-{{ block.id }} .wishlist-button.active { background: var(--text-color); color: var(--btn-bg); border-color: var(--text-color); opacity: 0.9; }
  .wishlist-app-container-{{ block.id }} .wishlist-icon svg { width: var(--icon-size); height: var(--icon-size); color: var(--icon-color); }
  .wishlist-app-container-{{ block.id }} .wishlist-button.active .wishlist-icon svg { color: var(--btn-bg); fill: currentColor; }
  .wishlist-app-container-{{ block.id }} .notify-btn { background: var(--notify-bg); color: var(--notify-text); border-color: var(--notify-border); }
  .wishlist-app-container-{{ block.id }} .notify-btn.registered { background: #eee !important; color: #888 !important; border-color: #ccc !important; }
  .wishlist-email-form { display: flex; flex-direction: column; gap: 12px; width: 100%; text-align: left; }
  .wishlist-email-input { width: 100%; padding: 12px; border: 1px solid #ccc; border-radius: 4px; font-size: 14px; box-sizing: border-box; background: #fff !important; color: #333 !important; }
  .wishlist-email-error { color: #d72c0d; font-size: 12px; display: none; margin-top: 5px; }

  /* â˜…ãƒˆãƒ¼ã‚¹ãƒˆã®ãƒ‡ã‚¶ã‚¤ãƒ³ï¼ˆç”»é¢ä¸Šéƒ¨ï¼‰ */
  #wishflow-toast-trigger {
    position: fixed; top: 20px; left: 50%; transform: translateX(-50%);
    background: #121212; color: #fff; padding: 15px 30px; border-radius: 8px;
    font-size: 15px; font-weight: bold; z-index: 2147483647; 
    box-shadow: 0 10px 25px rgba(0,0,0,0.4);
    transition: all 0.4s ease; opacity: 1;
    text-align: center; white-space: nowrap; pointer-events: none;
  }
  .wf-toast-hidden { opacity: 0 !important; top: -50px !important; }
</style>

<script>
  (function() {
    const PRODUCT_HANDLE = "{{ product.handle }}";
    const CUSTOMER_ID = "{{ customer.id }}";
    const BLOCK_ID = "{{ block.id }}";
    const NOTIFY_KEY = 'restock_notification_list'; 

    function getDesignSettings() {
      const el = document.getElementById(`wishlist-config-${BLOCK_ID}`);
      try { return JSON.parse(el.textContent); } catch (e) { return {}; }
    }

    // â˜…ãƒˆãƒ¼ã‚¹ãƒˆè¡¨ç¤ºç”¨é–¢æ•°
    function showToast(message) {
      const toast = document.getElementById('wishflow-toast-trigger');
      if (!toast) return;
      toast.textContent = message;
      toast.classList.remove('wf-toast-hidden');
      setTimeout(() => { toast.classList.add('wf-toast-hidden'); }, 3000);
    }

    // ğŸŒŸ ãŠæ°—ã«å…¥ã‚Šãƒœã‚¿ãƒ³ã®æ¥½è¦³çš„UIå¯¾å¿œ
    window.toggleWishlist = async function(handle) {
      const btn = document.getElementById(`wishlist-btn-${handle}`);
      btn.classList.toggle('active');
      const textSpan = document.getElementById(`wishlist-text-${handle}`);
      
      const isActive = btn.classList.contains('active');
      textSpan.textContent = isActive ? "{{ text_added }}" : "{{ text_add }}";

      // ã‚²ã‚¹ãƒˆç”¨ã®ãƒ­ãƒ¼ã‚«ãƒ«ä¿å­˜ã‚’å…ˆã«å‡¦ç†ï¼ˆçˆ†é€ŸåŒ–ï¼‰
      let list = JSON.parse(localStorage.getItem('wishflow_guest_list') || '[]');
      if (isActive) { if (!list.includes(handle)) list.push(handle); } 
      else { list = list.filter(h => h !== handle); }
      localStorage.setItem('wishflow_guest_list', JSON.stringify(list));

      // ãƒ­ã‚°ã‚¤ãƒ³ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å ´åˆã¯è£ã§ã‚µãƒ¼ãƒãƒ¼ã¨åŒæœŸ
      if (CUSTOMER_ID) {
        try {
          const rootPath = window.Shopify ? window.Shopify.routes.root : '/';
          await fetch(`${rootPath}apps/wishlist/api/wishlist`.replace('//', '/'), {
            method: 'POST', headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ customerId: CUSTOMER_ID, productHandle: handle, mode: 'toggle', referrer: document.referrer })
          });
        } catch (e) { console.error("Wishlist sync failed:", e); }
      }
    };

    // â˜…ãƒ¡ãƒ¼ãƒ«å…¥åŠ›ç”¨ãƒ¢ãƒ€ãƒ¼ãƒ«ï¼ˆã“ã‚Œã¯æ®‹ã™ï¼‰
    window.showCustomAlert = function(type = 'email_form', callback = null) {
      const existing = document.getElementById('wishlist-custom-alert');
      if (existing) existing.remove();
      const settings = getDesignSettings();
      const bgStyle = `background-color: ${settings.modalBgRgba};`;
      const glassEffect = settings.modalGlass ? 'backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px);' : '';
      const submitBtnStyle = `background-color: ${settings.submitBg} !important; color: ${settings.submitText} !important; border: ${settings.submitBorderWidth} solid ${settings.submitBorderColor} !important; border-radius: ${settings.submitRadius} !important; width: 100% !important; padding: 12px !important; font-weight: bold !important; cursor: pointer !important; margin-top: 10px !important; display: block !important; box-sizing: border-box !important; font-size: 14px !important;`;

      let contentHtml = `<div class="wishlist-email-form"><label style="font-weight:bold; margin-bottom:4px; display:block;">${settings.textEmailLabel}</label><input type="email" id="wishlist-guest-email" class="wishlist-email-input" placeholder="${settings.textEmailPlaceholder}"><div id="wishlist-email-error" class="wishlist-email-error"></div><button id="wishlist-email-submit-btn" style="${submitBtnStyle}">${settings.textSubmit}</button><button onclick="document.getElementById('wishlist-custom-alert').remove()" style="margin-top:10px; background:none; border:none; color:inherit; cursor:pointer; font-size:12px; text-decoration:underline; opacity:0.7;">${settings.textClose}</button></div>`;
      
      const html = `<div id="wishlist-custom-alert" style="position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: rgba(0,0,0,0.4); display: flex; align-items: center; justify-content: center; z-index: 2147483647;"><div style="${bgStyle} ${glassEffect} padding: 24px; border-radius: ${settings.modalRadius}; width: 90%; max-width: 320px; text-align: center; color: ${settings.modalText}; box-shadow: 0 10px 30px rgba(0,0,0,0.2);">${contentHtml}</div></div>`;
      document.body.insertAdjacentHTML('beforeend', html);

      if (callback) {
        document.getElementById('wishlist-email-submit-btn').onclick = function() {
          const email = document.getElementById('wishlist-guest-email').value.trim();
          if (!email || !email.includes('@')) { 
            const errorEl = document.getElementById('wishlist-email-error');
            errorEl.style.display = 'block'; errorEl.innerText = settings.textErrorEmail; return; 
          }
          localStorage.setItem('wishflow_guest_email', email); 
          callback(email); 
          document.getElementById('wishlist-custom-alert').remove();
        };
      }
    };

    // ğŸŒŸ é€šçŸ¥ãƒœã‚¿ãƒ³ã®å…¥ã‚Šå£
    window.requestNotify = async function(handle) {
      let email = "{{ customer.email }}" || localStorage.getItem('wishflow_guest_email');
      if (!email) { 
        window.showCustomAlert('email_form', (inputEmail) => sendNotifyRequest(handle, inputEmail)); 
      } else { 
        sendNotifyRequest(handle, email); 
      }
    };

    // ğŸŒŸ çˆ†é€Ÿé€šçŸ¥ãƒ­ã‚¸ãƒƒã‚¯ (æ¥½è¦³çš„UI)
    async function sendNotifyRequest(handle, email) {
      const btn = document.getElementById(`notify-btn-${handle}`);
      const isRegistered = btn.classList.contains('registered');
      const rootPath = window.Shopify ? window.Shopify.routes.root : '/';
      const variantId = "{{ product.selected_or_first_available_variant.id }}";
      const storageKey = `${handle}-${variantId}`;

      // 1. å…ˆã«è¦‹ãŸç›®ã¨ãƒˆãƒ¼ã‚¹ãƒˆã‚’å¤‰ãˆã‚‹ (çˆ†é€ŸåŒ–)
      btn.classList.toggle('registered');
      btn.textContent = btn.classList.contains('registered') ? "{{ text_subscribed }}" : "{{ text_notify }}";
      showToast(btn.classList.contains('registered') ? "{{ text_success_notified }}" : "{{ text_success_removed }}");

      let list = JSON.parse(localStorage.getItem(NOTIFY_KEY) || '[]');
      if (btn.classList.contains('registered')) { if (!list.includes(storageKey)) list.push(storageKey); } 
      else { list = list.filter(k => k !== storageKey && k !== handle); }
      localStorage.setItem(NOTIFY_KEY, JSON.stringify(list));

      // 2. è£ã§ã“ã£ãã‚Šã‚µãƒ¼ãƒãƒ¼ã¨é€šä¿¡
      try {
        await fetch(`${rootPath}apps/wishlist/notify`.replace('//', '/'), {
          method: 'POST', headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ productHandle: handle, variantId: variantId, customerEmail: email, actionType: isRegistered ? 'delete' : 'create', referrer: window.location.href })
        });
      } catch (e) { console.error("Notify sync failed:", e); }
    }

    function updateVisibility() {
      const notifyBtn = document.getElementById(`notify-btn-${PRODUCT_HANDLE}`);
      if (!notifyBtn) return;
      const isAvailable = {{ product.available | json }};
      notifyBtn.style.display = isAvailable ? 'none' : 'flex';
      const notifyList = JSON.parse(localStorage.getItem(NOTIFY_KEY) || '[]');
      const variantId = "{{ product.selected_or_first_available_variant.id }}";
      const storageKey = `${PRODUCT_HANDLE}-${variantId}`;
      if (notifyList.includes(storageKey) || notifyList.includes(PRODUCT_HANDLE)) {
        notifyBtn.classList.add('registered');
        notifyBtn.textContent = "{{ text_subscribed }}";
      }
      const guestList = JSON.parse(localStorage.getItem('wishflow_guest_list') || '[]');
      const metaRaw = {{ customer.metafields.custom.wishlist.value | json }};
      const serverList = metaRaw ? (Array.isArray(metaRaw) ? metaRaw : JSON.parse(metaRaw)) : [];
      if (guestList.includes(PRODUCT_HANDLE) || serverList.includes(PRODUCT_HANDLE)) {
        document.getElementById(`wishlist-btn-${PRODUCT_HANDLE}`).classList.add('active');
        document.getElementById(`wishlist-text-${PRODUCT_HANDLE}`).textContent = "{{ text_added }}";
      }
    }
    
    document.addEventListener("DOMContentLoaded", updateVisibility);
    window.addEventListener('wishflow:updated', (e) => {
      if (e.detail.handle === PRODUCT_HANDLE) updateVisibility();
    });

    // ğŸŒŸ ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºç”»é¢ã§ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’å¼·åˆ¶è¡¨ç¤ºã™ã‚‹é­”æ³•
    {% if request.design_mode and block.settings.show_email_preview %}
      setTimeout(() => {
        window.showCustomAlert('email_form');
      }, 500);
    {% endif %}
  })();
</script>

{% schema %}
{
  "name": "t:trigger.name",
  "target": "section",
  "templates": ["product"],
  "settings": [
    { "type": "header", "content": "t:trigger.header_text" },
    { "type": "text", "id": "text_add", "label": "t:trigger.add", "default": "ãŠæ°—ã«å…¥ã‚Šã«è¿½åŠ " },
    { "type": "text", "id": "text_added", "label": "t:trigger.added", "default": "è¿½åŠ æ¸ˆã¿" },
    { "type": "text", "id": "text_notify", "label": "t:trigger.notify", "default": "å…¥è·é€šçŸ¥ã‚’å—ã‘å–ã‚‹" },
    { "type": "text", "id": "text_subscribed", "label": "t:trigger.subscribed", "default": "å…¥è·é€šçŸ¥ç™»éŒ²æ¸ˆã¿" },
    { "type": "header", "content": "t:trigger.header_email" },
    { "type": "text", "id": "text_email_label", "label": "t:trigger.email_label", "default": "å…¥è·é€šçŸ¥ã‚’å—ã‘å–ã‚‹ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å…¥åŠ›" },
    { "type": "text", "id": "text_email_placeholder", "label": "t:trigger.email_placeholder", "default": "example@email.com" },
    { "type": "text", "id": "text_submit", "label": "t:trigger.submit", "default": "ç™»éŒ²ã™ã‚‹" },
    { "type": "text", "id": "text_close", "label": "t:trigger.close", "default": "é–‰ã˜ã‚‹" },
    { "type": "header", "content": "t:trigger.header_design" },
    { "type": "select", "id": "icon_type", "label": "t:trigger.icon_type", "options": [ { "value": "outline_heart", "label": "t:trigger.heart_outline" }, { "value": "solid_heart", "label": "t:trigger.heart_solid" }, { "value": "star", "label": "t:trigger.star" }, { "value": "bookmark", "label": "t:trigger.bookmark" } ], "default": "outline_heart" },
    { "type": "range", "id": "custom_icon_size", "label": "t:trigger.icon_size", "min": 10, "max": 40, "step": 1, "unit": "px", "default": 18 },
    { "type": "color", "id": "icon_color", "label": "t:trigger.text_color", "default": "#000000" },
    { "type": "range", "id": "custom_btn_padding", "label": "t:trigger.padding", "min": 5, "max": 30, "step": 1, "unit": "px", "default": 12 },
    { "type": "range", "id": "custom_border_radius", "label": "t:trigger.radius", "min": 0, "max": 50, "step": 1, "unit": "px", "default": 4 },
    { "type": "range", "id": "custom_border_width", "label": "t:trigger.border_width", "min": 0, "max": 5, "step": 1, "unit": "px", "default": 1 },
    { "type": "range", "id": "custom_text_size", "label": "t:trigger.text_size", "min": 10, "max": 24, "step": 1, "unit": "px", "default": 14 },
    { "type": "select", "id": "text_weight", "label": "t:account.title_weight", "options": [ { "value": "normal", "label": "t:account.normal" }, { "value": "bold", "label": "t:account.bold" } ], "default": "bold" },
    { "type": "color", "id": "btn_bg_color", "label": "t:trigger.bg_color", "default": "#ffffff" },
    { "type": "color", "id": "text_color", "label": "t:trigger.text_color", "default": "#000000" },
    { "type": "color", "id": "border_color", "label": "t:trigger.border_color", "default": "#000000" },
    { "type": "header", "content": "t:trigger.header_notify" },
    { "type": "color", "id": "notify_bg_color", "label": "t:trigger.bg_color", "default": "#ffffff" },
    { "type": "color", "id": "notify_text_color", "label": "t:trigger.text_color", "default": "#d72c0d" },
    { "type": "color", "id": "notify_border_color", "label": "t:trigger.border_color", "default": "#d72c0d" },
    { "type": "header", "content": "t:trigger.header_modal" },
    { "type": "checkbox", "id": "show_email_preview", "label": "ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’è¡¨ç¤º", "default": false },
    { "type": "checkbox", "id": "modal_glass_effect", "label": "t:trigger.glass_effect", "default": true },
    { "type": "color", "id": "modal_bg_color", "label": "t:trigger.bg_color", "default": "#ffffff" },
    { "type": "range", "id": "modal_bg_opacity", "label": "t:trigger.opacity", "min": 0, "max": 100, "step": 1, "unit": "%", "default": 85 },
    { "type": "color", "id": "modal_text_color", "label": "t:trigger.text_color", "default": "#121212" },
    { "type": "range", "id": "modal_radius", "label": "t:trigger.radius", "min": 0, "max": 50, "step": 1, "unit": "px", "default": 12 }
  ]
}
{% endschema %}