{%- comment -%} 
  --------------------------------------------------------------------------------
  お気に入りリストページ (wishlist-account.liquid)
  ★商品カードのデザインカスタム＆ダミープレビュー機能追加版
  ★多言語（自動翻訳）判定強化版 ＋ エディタ案内＆トーストの多言語対応版
  --------------------------------------------------------------------------------
{%- endcomment -%}

{%- assign store_lang = request.locale.iso_code | slice: 0, 2 -%}
{%- assign app_setting_lang = shop.metafields.wishflow_settings.language.value -%}
{%- assign global_lang = app_setting_lang | default: store_lang | default: 'ja' -%}

{%- assign val_title = block.settings.text_title | strip -%}
{%- assign val_desc = block.settings.text_desc | strip -%}
{%- assign use_translation = false -%}
{%- if val_title == blank or val_title == 'Wishlist' or val_title == 'お気に入りリスト' -%}
  {%- assign use_translation = true -%}
{%- elsif val_desc == blank or val_desc == 'Products you have saved.' or val_desc == 'あなたが保存した商品の一覧です' -%}
  {%- assign use_translation = true -%}
{%- endif -%}

{%- if use_translation -%}
  {%- case global_lang -%}
    {%- when 'en' -%}
      {%- assign lang_title = 'Wishlist' -%}
      {%- assign lang_desc = 'Products you have saved.' -%}
      {%- assign lang_empty = 'Your wishlist is currently empty.' -%}
      {%- assign lang_loading = 'Loading...' -%}
      {%- assign lang_sold_out = 'Sold Out' -%}
      {%- assign lang_remove_confirm = 'Remove this item from your wishlist?' -%}
      {%- assign lang_remove_tooltip = 'Remove' -%}
      {%- assign lang_notify = 'Notify Me' -%}
      {%- assign lang_subscribed = 'Notification Set' -%}
      {%- assign lang_success_reg = 'Notification Registered!' -%}
      {%- assign lang_success_del = 'Notification Removed' -%}
      {%- assign lang_email_label = 'Enter email for restock alerts' -%}
      {%- assign lang_email_placeholder = 'example@email.com' -%}
      {%- assign lang_submit = 'Register' -%}
      {%- assign lang_email_error = 'Please enter a valid email address.' -%}
      {%- assign lang_close = 'Close' -%}
      {%- assign lang_editor_msg = "Editor Mode (Turn ON 'Show Dummy Products Preview' in settings to adjust design)" -%}
      {%- assign lang_sample_product = "Sample Product" -%}
      {%- assign lang_toast_preview_msg = "Toast notification preview" -%}
    {%- when 'zh', 'zh-TW' -%}
      {%- assign lang_title = '收藏清單' -%}
      {%- assign lang_desc = '您保存的商品列表。' -%}
      {%- assign lang_empty = '您的收藏清單目前是空的。' -%}
      {%- assign lang_loading = '載入中...' -%}
      {%- assign lang_sold_out = '已售完' -%}
      {%- assign lang_remove_confirm = '確定要從收藏中刪除嗎？' -%}
      {%- assign lang_remove_tooltip = '刪除' -%}
      {%- assign lang_notify = '到貨通知我' -%}
      {%- assign lang_subscribed = '已訂閱通知' -%}
      {%- assign lang_success_reg = '已成功訂閱通知！' -%}
      {%- assign lang_success_del = '已取消通知訂閱' -%}
      {%- assign lang_email_label = '輸入接收通知的電子郵件' -%}
      {%- assign lang_email_placeholder = 'example@email.com' -%}
      {%- assign lang_submit = '提交' -%}
      {%- assign lang_email_error = '請輸入正確的電子郵件地址。' -%}
      {%- assign lang_close = '關閉' -%}
      {%- assign lang_editor_msg = "编辑器模式（在右侧设置中开启“显示测试商品预览”以调整设计）" -%}
      {%- assign lang_sample_product = "示例商品" -%}
      {%- assign lang_toast_preview_msg = "提示框预览" -%}
    {%- when 'fr' -%}
      {%- assign lang_title = 'Liste de souhaits' -%}
      {%- assign lang_desc = 'Les produits que vous avez enregistrés.' -%}
      {%- assign lang_empty = 'Votre liste de souhaits est vide.' -%}
      {%- assign lang_loading = 'Chargement...' -%}
      {%- assign lang_sold_out = 'Épuisé' -%}
      {%- assign lang_remove_confirm = 'Retirer cet article de votre liste de souhaits ?' -%}
      {%- assign lang_remove_tooltip = 'Retirer' -%}
      {%- assign lang_notify = 'M’informer' -%}
      {%- assign lang_subscribed = 'Notification activée' -%}
      {%- assign lang_success_reg = 'Notification activée !' -%}
      {%- assign lang_success_del = 'Notification annulée' -%}
      {%- assign lang_email_label = 'Entrez votre email pour les alertes de réapprovisionnement' -%}
      {%- assign lang_email_placeholder = 'example@email.com' -%}
      {%- assign lang_submit = 'S’inscrire' -%}
      {%- assign lang_email_error = 'Veuillez entrer une adresse e-mail valide.' -%}
      {%- assign lang_close = 'Fermer' -%}
      {%- assign lang_editor_msg = "Mode Éditeur (Activez 'Afficher l'aperçu des produits factices' dans les paramètres pour ajuster le design)" -%}
      {%- assign lang_sample_product = "Produit d'exemple" -%}
      {%- assign lang_toast_preview_msg = "Aperçu de la notification" -%}
    {%- when 'de' -%}
      {%- assign lang_title = 'Wunschliste' -%}
      {%- assign lang_desc = 'Ihre gespeicherten Produkte.' -%}
      {%- assign lang_empty = 'Ihre Wunschliste ist leer.' -%}
      {%- assign lang_loading = 'Laden...' -%}
      {%- assign lang_sold_out = 'Ausverkauft' -%}
      {%- assign lang_remove_confirm = 'Diesen Artikel von Ihrer Wunschliste entfernen?' -%}
      {%- assign lang_remove_tooltip = 'Entfernen' -%}
      {%- assign lang_notify = 'Benachrichtigen' -%}
      {%- assign lang_subscribed = 'Benachrichtigung aktiv' -%}
      {%- assign lang_success_reg = 'Benachrichtigung aktiviert!' -%}
      {%- assign lang_success_del = 'Benachrichtigung entfernt' -%}
      {%- assign lang_email_label = 'E-Mail für Benachrichtigungen eingeben' -%}
      {%- assign lang_email_placeholder = 'example@email.com' -%}
      {%- assign lang_submit = 'Registrieren' -%}
      {%- assign lang_email_error = 'Bitte geben Sie eine gültige E-Mail-Adresse ein.' -%}
      {%- assign lang_close = 'Schließen' -%}
      {%- assign lang_editor_msg = "Editor-Modus (Aktivieren Sie 'Vorschau mit Dummy-Produkten anzeigen' in den Einstellungen, um das Design anzupassen)" -%}
      {%- assign lang_sample_product = "Beispielprodukt" -%}
      {%- assign lang_toast_preview_msg = "Benachrichtigungsvorschau" -%}
    {%- when 'es' -%}
      {%- assign lang_title = 'Lista de deseos' -%}
      {%- assign lang_desc = 'Productos que has guardado.' -%}
      {%- assign lang_empty = 'Tu lista de deseos está vacía.' -%}
      {%- assign lang_loading = 'Cargando...' -%}
      {%- assign lang_sold_out = 'Agotado' -%}
      {%- assign lang_remove_confirm = '¿Eliminar este artículo de tu lista de deseos?' -%}
      {%- assign lang_remove_tooltip = 'Eliminar' -%}
      {%- assign lang_notify = 'Avisarme' -%}
      {%- assign lang_subscribed = 'Notificación activa' -%}
      {%- assign lang_success_reg = '¡Notificación activada!' -%}
      {%- assign lang_success_del = 'Notificación cancelada' -%}
      {%- assign lang_email_label = 'Introduce tu email para avisos de reposición' -%}
      {%- assign lang_email_placeholder = 'example@email.com' -%}
      {%- assign lang_submit = 'Registrar' -%}
      {%- assign lang_email_error = 'Por favor, introduce un email válido.' -%}
      {%- assign lang_close = 'Cerrar' -%}
      {%- assign lang_editor_msg = "Modo Editor (Active 'Mostrar vista previa de productos de prueba' en la configuración para ajustar el diseño)" -%}
      {%- assign lang_sample_product = "Producto de muestra" -%}
      {%- assign lang_toast_preview_msg = "Vista previa de notificación" -%}
    {%- else -%}
      {%- assign lang_title = 'お気に入りリスト' -%}
      {%- assign lang_desc = 'あなたが保存した商品の一覧です' -%}
      {%- assign lang_empty = 'お気に入りはまだありません' -%}
      {%- assign lang_loading = '読み込み中...' -%}
      {%- assign lang_sold_out = '売り切れ' -%}
      {%- assign lang_remove_confirm = 'お気に入りから削除しますか？' -%}
      {%- assign lang_remove_tooltip = '削除する' -%}
      {%- assign lang_notify = '入荷通知を受け取る' -%}
      {%- assign lang_subscribed = '入荷通知登録済み' -%}
      {%- assign lang_success_reg = '入荷通知を登録しました！' -%}
      {%- assign lang_success_del = '通知登録を解除しました' -%}
      {%- assign lang_email_label = '入荷通知を受け取るメールアドレスを入力' -%}
      {%- assign lang_email_placeholder = 'example@email.com' -%}
      {%- assign lang_submit = '登録する' -%}
      {%- assign lang_email_error = '正しいメールアドレスを入力してください' -%}
      {%- assign lang_close = '閉じる' -%}
      {%- assign lang_editor_msg = "エディタモード（右側の設定から「ダミー商品を表示」をONにするとデザイン調整ができます）" -%}
      {%- assign lang_sample_product = "サンプル商品" -%}
      {%- assign lang_toast_preview_msg = "デザイン確認用のトーストです" -%}
  {%- endcase -%}
{%- else -%}
  {%- assign lang_title = block.settings.text_title | default: 'お気に入りリスト' -%}
  {%- assign lang_desc = block.settings.text_desc | default: 'あなたが保存した商品の一覧です' -%}
  {%- assign lang_empty = 'お気に入りはまだありません' -%}
  {%- assign lang_loading = '読み込み中...' -%}
  {%- assign lang_sold_out = '売り切れ' -%}
  {%- assign lang_remove_confirm = 'お気に入りから削除しますか？' -%}
  {%- assign lang_remove_tooltip = '削除する' -%}
  {%- assign lang_notify = '入荷通知を受け取る' -%}
  {%- assign lang_subscribed = '入荷通知登録済み' -%}
  {%- assign lang_success_reg = '入荷通知を登録しました！' -%}
  {%- assign lang_success_del = '通知登録を解除しました' -%}
  {%- assign lang_email_label = '入荷通知を受け取るメールアドレスを入力' -%}
  {%- assign lang_email_placeholder = 'example@email.com' -%}
  {%- assign lang_submit = '登録する' -%}
  {%- assign lang_email_error = '正しいメールアドレスを入力してください' -%}
  {%- assign lang_close = '閉じる' -%}
  {%- assign lang_editor_msg = "エディタモード（右側の設定から「ダミー商品を表示」をONにするとデザイン調整ができます）" -%}
  {%- assign lang_sample_product = "サンプル商品" -%}
  {%- assign lang_toast_preview_msg = "デザイン確認用のトーストです" -%}
{%- endif -%}

<div class="wishlist-modern-container wishlist-container-{{ block.id }}">
  <header class="wishlist-header">
    <h1 class="wishlist-title">{{ lang_title | escape }}</h1>
    <div class="wishlist-guide">
      <p>{{ lang_desc | escape }}</p>
    </div>
  </header>
  <div id="wishlist-items" class="wishlist-grid-list">
    <p id="wishlist-loading-msg" class="loading-msg">{{ lang_loading }}</p>
  </div>
</div>

<div id="wishflow-toast" class="wf-toast-hidden"></div>

{%- assign t_opacity = block.settings.toast_bg_opacity | default: 85 -%}
{%- assign t_alpha = t_opacity | divided_by: 100.0 -%}
{%- assign t_bg_raw = block.settings.toast_bg_color | default: '#121212' -%}
{%- assign t_bg_rgba = t_bg_raw | color_modify: 'alpha', t_alpha -%}

{%- assign modal_bg_color = block.settings.modal_bg_color | default: '#ffffff' -%}
{%- assign modal_opacity_decimal = block.settings.modal_bg_opacity | default: 85 | divided_by: 100.0 -%}
{%- assign modal_bg_rgba = modal_bg_color | color_modify: 'alpha', modal_opacity_decimal -%}
{%- assign modal_text_color = block.settings.modal_text_color | default: '#121212' -%}
{%- assign modal_radius = block.settings.modal_radius | default: 12 -%}
{%- assign modal_btn_bg = block.settings.modal_btn_bg_color | default: '#121212' -%}
{%- assign modal_btn_text = block.settings.modal_btn_text_color | default: '#ffffff' -%}

<style>
  .wishlist-container-{{ block.id }} {
    max-width: 900px; margin: 40px auto; padding: 0 20px; color: #121212;
    --header-align: {{ block.settings.header_align }};
    --title-size: {{ block.settings.title_size }}px;
    --title-weight: {{ block.settings.title_weight }};
    --title-color: {{ block.settings.title_color }};
    --desc-size: {{ block.settings.desc_size }}px;
    --desc-weight: {{ block.settings.desc_weight }};
    --desc-color: {{ block.settings.desc_color }};
    --name-size: {{ block.settings.custom_name_text_size }}px;
    --name-weight: {{ block.settings.name_weight }};
    --price-size: {{ block.settings.custom_price_text_size }}px;
    --price-weight: {{ block.settings.price_weight }};
    --card-notify-bg: {{ block.settings.card_notify_bg_color }};
    --card-notify-text: {{ block.settings.card_notify_text_color }};
    --card-notify-border: {{ block.settings.card_notify_border_color }};
  }
  .wishlist-container-{{ block.id }} .wishlist-header { text-align: var(--header-align); margin-bottom: 30px; }
  .wishlist-container-{{ block.id }} .wishlist-title { font-size: var(--title-size); font-weight: var(--title-weight); color: var(--title-color); letter-spacing: 0.05em; text-transform: uppercase; margin: 0 0 10px 0; }
  .wishlist-container-{{ block.id }} .wishlist-guide p { font-size: var(--desc-size); font-weight: var(--desc-weight); color: var(--desc-color); margin: 0; }
  .wishlist-grid-list { display: grid; grid-template-columns: repeat(2, 1fr); gap: 30px 20px; border-top: 1px solid #e8e8e8; padding-top: 30px; min-height: 200px; }
  @media (min-width: 768px) { .wishlist-grid-list { grid-template-columns: repeat(4, 1fr); } }
  .wishlist-item { position: relative; display: flex; flex-direction: column; text-align: center; }
  .item-image-link { position: relative; display: block; aspect-ratio: 1/1; background: #f9f9f9; margin-bottom: 12px; overflow: hidden; border: 1px solid #eee; }
  .item-image { width: 100%; height: 100%; object-fit: cover; transition: transform 0.3s ease; }
  .sold-out-badge { position: absolute; bottom: 0; right: 0; background: rgba(0, 0, 0, 0.7); color: #fff; padding: 4px 8px; font-size: 10px; font-weight: bold; }
  .wishlist-container-{{ block.id }} .item-name { font-size: var(--name-size); font-weight: var(--name-weight); text-decoration: none; color: inherit; margin-bottom: 4px; display: block; line-height: 1.4; }
  .wishlist-container-{{ block.id }} .item-price { font-size: var(--price-size); font-weight: var(--price-weight); color: #666; }
  .remove-btn { position: absolute; top: 5px; right: 5px; background: rgba(255,255,255,0.9); border: 1px solid #ddd; width: 32px; height: 32px; border-radius: 50%; cursor: pointer; z-index: 2; display: flex; align-items: center; justify-content: center; font-size: 18px; transition: 0.2s; color: #666; }
  .notify-btn-small { margin-top: 8px; width: 100%; padding: 8px; background: var(--card-notify-bg); border: 1px solid var(--card-notify-border); color: var(--card-notify-text); font-size: 12px; font-weight: bold; border-radius: 4px; cursor: pointer; transition: 0.2s; }
  .notify-btn-small.registered { background: #eee !important; border-color: #ccc !important; color: #888 !important; }

  #wishflow-toast {
    position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%);
    background-color: {{ t_bg_rgba }};
    {% if block.settings.toast_glass_effect %}
    backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px);
    {% endif %}
    color: {{ block.settings.toast_text_color | default: '#ffffff' }};
    padding: 12px 24px; border-radius: 30px;
    font-size: 14px; font-weight: bold; z-index: 100000; box-shadow: 0 4px 15px rgba(0,0,0,0.3);
    transition: all 0.3s ease; opacity: 1;
  }
  .wf-toast-hidden { opacity: 0 !important; bottom: 10px !important; pointer-events: none; }
</style>

<script>
  (function() {
    const STORAGE_KEY = 'wishflow_guest_list';
    const NOTIFY_STORAGE_KEY = 'restock_notification_list';
    const CUSTOMER_ID = "{{ customer.id }}";
    const CONTAINER = document.getElementById('wishlist-items');
    const LOADING_MSG = document.getElementById('wishlist-loading-msg');

    function getGuestList() { try { return JSON.parse(localStorage.getItem(STORAGE_KEY)) || []; } catch (e) { return []; } }
    function setGuestList(list) { localStorage.setItem(STORAGE_KEY, JSON.stringify(list)); }
    function getNotifyList() { try { return JSON.parse(localStorage.getItem(NOTIFY_STORAGE_KEY)) || []; } catch (e) { return []; } }

    function showToast(message) {
      const toast = document.getElementById('wishflow-toast');
      toast.textContent = message;
      toast.classList.remove('wf-toast-hidden');
      setTimeout(() => { toast.classList.add('wf-toast-hidden'); }, 3000);
    }

    async function init() {
      {% if request.design_mode %}
        {% if block.settings.show_card_preview %}
          const dummyHtml = `
            <div class="wishlist-item"><button class="remove-btn">×</button><a href="#" class="item-image-link"><img src="//cdn.shopify.com/s/images/themes/product-1.png" class="item-image" alt="Sample"><span class="sold-out-badge">{{ lang_sold_out }}</span></a><div class="wishlist-item-info"><a href="#" class="item-name">{{ lang_sample_product }} A</a><span class="item-price">¥5,000</span><button class="notify-btn-small">{{ lang_notify }}</button></div></div>
            <div class="wishlist-item"><button class="remove-btn">×</button><a href="#" class="item-image-link"><img src="//cdn.shopify.com/s/images/themes/product-2.png" class="item-image" alt="Sample"></a><div class="wishlist-item-info"><a href="#" class="item-name">{{ lang_sample_product }} B</a><span class="item-price">¥12,000</span></div></div>
            <div class="wishlist-item"><button class="remove-btn">×</button><a href="#" class="item-image-link"><img src="//cdn.shopify.com/s/images/themes/product-3.png" class="item-image" alt="Sample"><span class="sold-out-badge">{{ lang_sold_out }}</span></a><div class="wishlist-item-info"><a href="#" class="item-name">{{ lang_sample_product }} C</a><span class="item-price">¥8,500</span><button class="notify-btn-small registered">{{ lang_subscribed }}</button></div></div>
            <div class="wishlist-item"><button class="remove-btn">×</button><a href="#" class="item-image-link"><img src="//cdn.shopify.com/s/images/themes/product-4.png" class="item-image" alt="Sample"></a><div class="wishlist-item-info"><a href="#" class="item-name">{{ lang_sample_product }} D</a><span class="item-price">¥3,200</span></div></div>
          `;
          CONTAINER.innerHTML = dummyHtml;
          return;
        {% else %}
          if (LOADING_MSG) LOADING_MSG.innerText = "{{ lang_editor_msg }}";
          return;
        {% endif %}
      {% endif %}

      let wishlist = [];
      const metaRaw = {{ customer.metafields.custom.wishlist.value | json }};
      if (metaRaw) { try { wishlist = [...wishlist, ...(Array.isArray(metaRaw) ? metaRaw : JSON.parse(metaRaw))]; } catch(e){} }
      wishlist = [...new Set([...wishlist, ...getGuestList()])].filter(h => h);

      if (wishlist.length === 0) { LOADING_MSG.innerText = "{{ lang_empty }}"; return; }
      const notifyList = getNotifyList();
      const rootPath = window.Shopify ? window.Shopify.routes.root : '/';
      
      const products = await Promise.all(wishlist.map(async (handle) => {
        try {
          const res = await fetch(`${rootPath}products/${handle.trim()}.js`.replace('//', '/'));
          return res.ok ? await res.json() : null;
        } catch (err) { return null; }
      }));

      let html = '';
      for (const product of products) {
        if (!product) continue;
        const imgUrl = product.featured_image || '//cdn.shopify.com/s/images/themes/product-1.png';
        const price = (product.price / 100).toLocaleString();
        
        let badgeHtml = '', notifyBtnHtml = '';
        if (!product.available) {
          badgeHtml = `<span class="sold-out-badge">{{ lang_sold_out }}</span>`;
          const isRegistered = notifyList.some(key => key.includes(product.handle) || key.includes(product.variants[0].id.toString()));
          const btnText = isRegistered ? "{{ lang_subscribed }}" : "{{ lang_notify }}";
          const btnClass = isRegistered ? "notify-btn-small registered" : "notify-btn-small";
          notifyBtnHtml = `<button class="${btnClass}" id="list-notify-${product.handle}" onclick="window.requestNotifyFromList('${product.handle}', ${product.variants[0].id})">${btnText}</button>`;
        }
        html += `<div class="wishlist-item" id="item-${product.handle}"><button class="remove-btn" onclick="removeWish('${product.handle}')">×</button><a href="${product.url}" class="item-image-link"><img src="${imgUrl}" class="item-image" alt="${product.title}">${badgeHtml}</a><div class="wishlist-item-info"><a href="${product.url}" class="item-name">${product.title}</a><span class="item-price">¥${price}</span>${notifyBtnHtml}</div></div>`;
      }
      if (html) { CONTAINER.innerHTML = html; } else { LOADING_MSG.innerText = "{{ lang_empty }}"; }
    }

    async function sendNotifyRequestList(handle, variantId, email) {
      const btn = document.getElementById(`list-notify-${handle}`);
      if (!btn) return;
      const isRegistered = btn.classList.contains('registered');
      const rootPath = window.Shopify ? window.Shopify.routes.root : '/';

      let list = getNotifyList();
      const storageKey = `${handle}-${variantId}`;
      if (isRegistered) {
        list = list.filter(i => i !== storageKey && i !== handle);
        btn.textContent = "{{ lang_notify }}"; btn.classList.remove('registered');
        showToast("{{ lang_success_del }}");
      } else {
        if (!list.includes(storageKey)) list.push(storageKey);
        btn.textContent = "{{ lang_subscribed }}"; btn.classList.add('registered');
        showToast("{{ lang_success_reg }}");
      }
      localStorage.setItem(NOTIFY_STORAGE_KEY, JSON.stringify(list));

      try {
        await fetch(`${rootPath}apps/wishlist/notify`.replace('//', '/'), {
          method: 'POST', headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ productHandle: handle, variantId: variantId, customerEmail: email, actionType: isRegistered ? 'delete' : 'create', referrer: window.location.href })
        });
      } catch (e) { console.error("Sync failed:", e); }
    }

    window.removeWish = async function(handle) {
      if (!confirm("{{ lang_remove_confirm }}")) return;
      const el = document.getElementById(`item-${handle}`);
      if (el) el.remove();
      let list = getGuestList().filter(h => h !== handle);
      setGuestList(list);
      if (CUSTOMER_ID) {
        try {
          const rootPath = window.Shopify ? window.Shopify.routes.root : '/';
          await fetch(`${rootPath}apps/wishlist/api/wishlist`.replace('//', '/'), {
            method: 'POST', headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ customerId: CUSTOMER_ID, productHandle: handle, mode: 'delete' })
          });
        } catch(e) { console.error(e); }
      }
    };

    window.requestNotifyFromList = async function(handle, variantId) {
      let email = "{{ customer.email }}" || localStorage.getItem('wishflow_guest_email');
      if (!email) { showEmailModal((inputEmail) => sendNotifyRequestList(handle, variantId, inputEmail)); } 
      else { sendNotifyRequestList(handle, variantId, email); }
    };

    function showEmailModal(callback) {
      const existing = document.getElementById('wishlist-custom-alert');
      if (existing) existing.remove();
      const savedEmail = localStorage.getItem('wishflow_guest_email') || '';
      
      const glassEffect = {% if block.settings.modal_glass_effect %}'backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px);'{% else %}''{% endif %};
      const bgColor = '{{ modal_bg_rgba }}';
      const textColor = '{{ modal_text_color }}';
      const radius = '{{ modal_radius }}px';
      const btnBg = '{{ modal_btn_bg }}';
      const btnText = '{{ modal_btn_text }}';

      const html = `
        <div id="wishlist-custom-alert" style="position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: rgba(0,0,0,0.4); display: flex; align-items: center; justify-content: center; z-index: 99999;">
          <div style="background-color: ${bgColor}; color: ${textColor}; border-radius: ${radius}; ${glassEffect} padding: 24px; width: 90%; max-width: 320px; text-align: center; box-shadow: 0 10px 30px rgba(0,0,0,0.2);">
            <div class="wishlist-email-form">
              <label style="font-weight:bold; margin-bottom:4px; display:block; text-align:left;">{{ lang_email_label }}</label>
              <input type="email" id="wishlist-guest-email-list" style="width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; color: #333;" value="${savedEmail}" placeholder="{{ lang_email_placeholder }}">
              <div id="wishlist-email-error-list" style="color:red; font-size:12px; display:none; margin-top:5px;"></div>
              <button id="wishlist-email-submit-list" style="width: 100%; padding: 10px; background-color: ${btnBg}; color: ${btnText}; border: none; border-radius: 4px; font-weight: bold; cursor: pointer; margin-top: 10px;">{{ lang_submit }}</button>
              <button onclick="document.getElementById('wishlist-custom-alert').remove()" style="margin-top:10px; background:none; border:none; color:inherit; cursor:pointer; opacity:0.7;">{{ lang_close }}</button>
            </div>
          </div>
        </div>`;
      document.body.insertAdjacentHTML('beforeend', html);
      document.getElementById('wishlist-email-submit-list').onclick = function() {
        const email = document.getElementById('wishlist-guest-email-list').value.trim();
        if (!email || !email.includes('@')) { 
          const err = document.getElementById('wishlist-email-error-list');
          err.innerText = "{{ lang_email_error }}"; err.style.display = 'block'; return; 
        }
        localStorage.setItem('wishflow_guest_email', email);
        callback(email); document.getElementById('wishlist-custom-alert').remove();
      };
    }

    document.addEventListener("DOMContentLoaded", init);
    window.addEventListener('wishflow:updated', init);

    {% if request.design_mode %}
      {% if block.settings.show_email_preview %}
        setTimeout(() => { 
          if(typeof showEmailModal === 'function') showEmailModal(() => {}); 
        }, 500);
      {% endif %}
      {% if block.settings.show_toast_preview %}
        setTimeout(() => { 
          const t = document.getElementById('wishflow-toast');
          if(t) {
            t.textContent = "✓ " + "{{ lang_toast_preview_msg }}";
            t.classList.remove('wf-toast-hidden');
          }
        }, 1000);
      {% endif %}
    {% endif %}

  })();
</script>

{% schema %}
{
  "name": "t:account.name",
  "target": "section",
  "settings": [
    { "type": "header", "content": "t:account.header_text" },
    { "type": "text", "id": "text_title", "label": "t:account.title", "default": "t:account.default_title" },
    { "type": "text", "id": "text_desc", "label": "t:account.desc", "default": "t:account.default_desc" },
    { "type": "select", "id": "header_align", "label": "t:account.align", "options": [
      { "value": "left", "label": "t:account.left" },
      { "value": "center", "label": "t:account.center" },
      { "value": "right", "label": "t:account.right" }
    ], "default": "center" },
    { "type": "color", "id": "title_color", "label": "t:account.title_color", "default": "#121212" },
    { "type": "color", "id": "desc_color", "label": "t:account.desc_color", "default": "#666666" },
    { "type": "header", "content": "t:account.header_design" },
    { "type": "range", "id": "title_size", "label": "t:account.title_size", "min": 16, "max": 40, "step": 1, "unit": "px", "default": 24 },
    { "type": "select", "id": "title_weight", "label": "t:account.title_weight", "options": [
      { "value": "normal", "label": "t:account.normal" },
      { "value": "bold", "label": "t:account.bold" }
    ], "default": "normal" },

    { "type": "header", "content": "t:account.header_card" },
    { "type": "checkbox", "id": "show_card_preview", "label": "t:account.show_card_preview", "default": false },
    { "type": "range", "id": "custom_name_text_size", "label": "t:account.custom_name_text_size", "min": 10, "max": 24, "step": 1, "unit": "px", "default": 14 },
    { "type": "select", "id": "name_weight", "label": "t:account.name_weight", "options": [ { "value": "normal", "label": "t:account.normal" }, { "value": "bold", "label": "t:account.bold" } ], "default": "bold" },
    { "type": "range", "id": "custom_price_text_size", "label": "t:account.custom_price_text_size", "min": 10, "max": 24, "step": 1, "unit": "px", "default": 13 },
    { "type": "select", "id": "price_weight", "label": "t:account.price_weight", "options": [ { "value": "normal", "label": "t:account.normal" }, { "value": "bold", "label": "t:account.bold" } ], "default": "normal" },
    { "type": "color", "id": "card_notify_bg_color", "label": "t:account.card_notify_bg_color", "default": "#ffffff" },
    { "type": "color", "id": "card_notify_text_color", "label": "t:account.card_notify_text_color", "default": "#d72c0d" },
    { "type": "color", "id": "card_notify_border_color", "label": "t:account.card_notify_border_color", "default": "#d72c0d" },

    { "type": "header", "content": "t:account.header_email_design" },
    { "type": "checkbox", "id": "show_email_preview", "label": "t:account.show_email_preview", "default": false },
    { "type": "checkbox", "id": "modal_glass_effect", "label": "t:account.modal_glass_effect", "default": true },
    { "type": "color", "id": "modal_bg_color", "label": "t:account.modal_bg_color", "default": "#ffffff" },
    { "type": "range", "id": "modal_bg_opacity", "label": "t:account.modal_bg_opacity", "min": 0, "max": 100, "step": 1, "unit": "%", "default": 85 },
    { "type": "color", "id": "modal_text_color", "label": "t:account.modal_text_color", "default": "#121212" },
    { "type": "range", "id": "modal_radius", "label": "t:account.modal_radius", "min": 0, "max": 50, "step": 1, "unit": "px", "default": 12 },
    { "type": "color", "id": "modal_btn_bg_color", "label": "t:account.modal_btn_bg_color", "default": "#121212" },
    { "type": "color", "id": "modal_btn_text_color", "label": "t:account.modal_btn_text_color", "default": "#ffffff" },

    { "type": "header", "content": "t:account.header_toast" },
    { "type": "checkbox", "id": "show_toast_preview", "label": "t:account.show_toast_preview", "default": false },
    { "type": "checkbox", "id": "toast_glass_effect", "label": "t:account.toast_glass_effect", "default": true },
    { "type": "color", "id": "toast_bg_color", "label": "t:account.toast_bg_color", "default": "#121212" },
    { "type": "range", "id": "toast_bg_opacity", "label": "t:account.toast_bg_opacity", "min": 0, "max": 100, "step": 1, "unit": "%", "default": 85 },
    { "type": "color", "id": "toast_text_color", "label": "t:account.toast_text_color", "default": "#ffffff" }
  ] 
}
{% endschema %}