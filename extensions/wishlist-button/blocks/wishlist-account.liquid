{%- comment -%} 
  --------------------------------------------------------------------------------
  ãŠæ°—ã«å…¥ã‚Šãƒªã‚¹ãƒˆãƒšãƒ¼ã‚¸ (wishlist-account.liquid)
  â˜…å•†å“ã‚«ãƒ¼ãƒ‰ã®ãƒ‡ã‚¶ã‚¤ãƒ³ã‚«ã‚¹ã‚¿ãƒ ï¼†ãƒ€ãƒŸãƒ¼ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼æ©Ÿèƒ½è¿½åŠ ç‰ˆ
  â˜…å¤šè¨€èªï¼ˆè‡ªå‹•ç¿»è¨³ï¼‰åˆ¤å®šå¼·åŒ–ç‰ˆ ï¼‹ ã‚¨ãƒ‡ã‚£ã‚¿æ¡ˆå†…æ–‡ã®å¤šè¨€èªå¯¾å¿œç‰ˆ
  --------------------------------------------------------------------------------
{%- endcomment -%}

{%- assign store_lang = request.locale.iso_code | slice: 0, 2 -%}
{%- assign app_setting_lang = shop.metafields.wishflow_settings.language.value -%}
{%- assign global_lang = app_setting_lang | default: store_lang | default: 'ja' -%}

{%- assign val_title = block.settings.text_title | strip -%}
{%- assign val_desc = block.settings.text_desc | strip -%}
{%- assign use_translation = false -%}
{%- if val_title == blank or val_title == 'Wishlist' or val_title == 'ãŠæ°—ã«å…¥ã‚Šãƒªã‚¹ãƒˆ' -%}
  {%- assign use_translation = true -%}
{%- elsif val_desc == blank or val_desc == 'Products you have saved.' or val_desc == 'ã‚ãªãŸãŒä¿å­˜ã—ãŸå•†å“ã®ä¸€è¦§ã§ã™' -%}
  {%- assign use_translation = true -%}
{%- endif -%}

{%- if use_translation -%}
  {%- case global_lang -%}
    {%- when 'en' -%}
      {%- assign lang_title = 'Wishlist' -%}
      {%- assign lang_desc = 'Products you have saved.' -%}
      {%- assign lang_empty = 'Your wishlist is currently empty.' -%}
      {%- assign lang_loading = 'Loading...' -%}
      {%- assign lang_sold_out = 'Sold Out' -%}
      {%- assign lang_remove_confirm = 'Remove this item from your wishlist?' -%}
      {%- assign lang_remove_tooltip = 'Remove' -%}
      {%- assign lang_notify = 'Notify Me' -%}
      {%- assign lang_subscribed = 'Notification Set' -%}
      {%- assign lang_success_reg = 'Notification Registered!' -%}
      {%- assign lang_success_del = 'Notification Removed' -%}
      {%- assign lang_email_label = 'Enter email for restock alerts' -%}
      {%- assign lang_email_placeholder = 'example@email.com' -%}
      {%- assign lang_submit = 'Register' -%}
      {%- assign lang_email_error = 'Please enter a valid email address.' -%}
      {%- assign lang_close = 'Close' -%}
      {%- assign lang_editor_msg = "Editor Mode (Turn ON 'Show Dummy Products Preview' in settings to adjust design)" -%}
      {%- assign lang_sample_product = "Sample Product" -%}
    {%- when 'zh', 'zh-TW' -%}
      {%- assign lang_title = 'æ”¶è—æ¸…å–®' -%}
      {%- assign lang_desc = 'æ‚¨ä¿å­˜çš„å•†å“åˆ—è¡¨ã€‚' -%}
      {%- assign lang_empty = 'æ‚¨çš„æ”¶è—æ¸…å–®ç›®å‰æ˜¯ç©ºçš„ã€‚' -%}
      {%- assign lang_loading = 'è¼‰å…¥ä¸­...' -%}
      {%- assign lang_sold_out = 'å·²å”®å®Œ' -%}
      {%- assign lang_remove_confirm = 'ç¢ºå®šè¦å¾æ”¶è—ä¸­åˆªé™¤å—ï¼Ÿ' -%}
      {%- assign lang_remove_tooltip = 'åˆªé™¤' -%}
      {%- assign lang_notify = 'åˆ°è²¨é€šçŸ¥æˆ‘' -%}
      {%- assign lang_subscribed = 'å·²è¨‚é–±é€šçŸ¥' -%}
      {%- assign lang_success_reg = 'å·²æˆåŠŸè¨‚é–±é€šçŸ¥ï¼' -%}
      {%- assign lang_success_del = 'å·²å–æ¶ˆé€šçŸ¥è¨‚é–±' -%}
      {%- assign lang_email_label = 'è¼¸å…¥æ¥æ”¶é€šçŸ¥çš„é›»å­éƒµä»¶' -%}
      {%- assign lang_email_placeholder = 'example@email.com' -%}
      {%- assign lang_submit = 'æäº¤' -%}
      {%- assign lang_email_error = 'è«‹è¼¸å…¥æ­£ç¢ºçš„é›»å­éƒµä»¶åœ°å€ã€‚' -%}
      {%- assign lang_close = 'é—œé–‰' -%}
      {%- assign lang_editor_msg = "ç¼–è¾‘å™¨æ¨¡å¼ï¼ˆåœ¨å³ä¾§è®¾ç½®ä¸­å¼€å¯â€œæ˜¾ç¤ºæµ‹è¯•å•†å“é¢„è§ˆâ€ä»¥è°ƒæ•´è®¾è®¡ï¼‰" -%}
      {%- assign lang_sample_product = "ç¤ºä¾‹å•†å“" -%}
    {%- when 'fr' -%}
      {%- assign lang_title = 'Liste de souhaits' -%}
      {%- assign lang_desc = 'Les produits que vous avez enregistrÃ©s.' -%}
      {%- assign lang_empty = 'Votre liste de souhaits est vide.' -%}
      {%- assign lang_loading = 'Chargement...' -%}
      {%- assign lang_sold_out = 'Ã‰puisÃ©' -%}
      {%- assign lang_remove_confirm = 'Retirer cet article de votre liste de souhaits ?' -%}
      {%- assign lang_remove_tooltip = 'Retirer' -%}
      {%- assign lang_notify = 'Mâ€™informer' -%}
      {%- assign lang_subscribed = 'Notification activÃ©e' -%}
      {%- assign lang_success_reg = 'Notification activÃ©e !' -%}
      {%- assign lang_success_del = 'Notification annulÃ©e' -%}
      {%- assign lang_email_label = 'Entrez votre email pour les alertes de rÃ©approvisionnement' -%}
      {%- assign lang_email_placeholder = 'example@email.com' -%}
      {%- assign lang_submit = 'Sâ€™inscrire' -%}
      {%- assign lang_email_error = 'Veuillez entrer une adresse e-mail valide.' -%}
      {%- assign lang_close = 'Fermer' -%}
      {%- assign lang_editor_msg = "Mode Ã‰diteur (Activez 'Afficher l'aperÃ§u des produits factices' dans les paramÃ¨tres pour ajuster le design)" -%}
      {%- assign lang_sample_product = "Produit d'exemple" -%}
    {%- when 'de' -%}
      {%- assign lang_title = 'Wunschliste' -%}
      {%- assign lang_desc = 'Ihre gespeicherten Produkte.' -%}
      {%- assign lang_empty = 'Ihre Wunschliste ist leer.' -%}
      {%- assign lang_loading = 'Laden...' -%}
      {%- assign lang_sold_out = 'Ausverkauft' -%}
      {%- assign lang_remove_confirm = 'Diesen Artikel von Ihrer Wunschliste entfernen?' -%}
      {%- assign lang_remove_tooltip = 'Entfernen' -%}
      {%- assign lang_notify = 'Benachrichtigen' -%}
      {%- assign lang_subscribed = 'Benachrichtigung aktiv' -%}
      {%- assign lang_success_reg = 'Benachrichtigung aktiviert!' -%}
      {%- assign lang_success_del = 'Benachrichtigung entfernt' -%}
      {%- assign lang_email_label = 'E-Mail fÃ¼r Benachrichtigungen eingeben' -%}
      {%- assign lang_email_placeholder = 'example@email.com' -%}
      {%- assign lang_submit = 'Registrieren' -%}
      {%- assign lang_email_error = 'Bitte geben Sie eine gÃ¼ltige E-Mail-Adresse ein.' -%}
      {%- assign lang_close = 'SchlieÃŸen' -%}
      {%- assign lang_editor_msg = "Editor-Modus (Aktivieren Sie 'Vorschau mit Dummy-Produkten anzeigen' in den Einstellungen, um das Design anzupassen)" -%}
      {%- assign lang_sample_product = "Beispielprodukt" -%}
    {%- when 'es' -%}
      {%- assign lang_title = 'Lista de deseos' -%}
      {%- assign lang_desc = 'Productos que has guardado.' -%}
      {%- assign lang_empty = 'Tu lista de deseos estÃ¡ vacÃ­a.' -%}
      {%- assign lang_loading = 'Cargando...' -%}
      {%- assign lang_sold_out = 'Agotado' -%}
      {%- assign lang_remove_confirm = 'Â¿Eliminar este artÃ­culo de tu lista de deseos?' -%}
      {%- assign lang_remove_tooltip = 'Eliminar' -%}
      {%- assign lang_notify = 'Avisarme' -%}
      {%- assign lang_subscribed = 'NotificaciÃ³n activa' -%}
      {%- assign lang_success_reg = 'Â¡NotificaciÃ³n activada!' -%}
      {%- assign lang_success_del = 'NotificaciÃ³n cancelada' -%}
      {%- assign lang_email_label = 'Introduce tu email para avisos de reposiciÃ³n' -%}
      {%- assign lang_email_placeholder = 'example@email.com' -%}
      {%- assign lang_submit = 'Registrar' -%}
      {%- assign lang_email_error = 'Por favor, introduce un email vÃ¡lido.' -%}
      {%- assign lang_close = 'Cerrar' -%}
      {%- assign lang_editor_msg = "Modo Editor (Active 'Mostrar vista previa de productos de prueba' en la configuraciÃ³n para ajustar el diseÃ±o)" -%}
      {%- assign lang_sample_product = "Producto de muestra" -%}
    {%- else -%}
      {%- assign lang_title = 'ãŠæ°—ã«å…¥ã‚Šãƒªã‚¹ãƒˆ' -%}
      {%- assign lang_desc = 'ã‚ãªãŸãŒä¿å­˜ã—ãŸå•†å“ã®ä¸€è¦§ã§ã™' -%}
      {%- assign lang_empty = 'ãŠæ°—ã«å…¥ã‚Šã¯ã¾ã ã‚ã‚Šã¾ã›ã‚“' -%}
      {%- assign lang_loading = 'èª­ã¿è¾¼ã¿ä¸­...' -%}
      {%- assign lang_sold_out = 'å£²ã‚Šåˆ‡ã‚Œ' -%}
      {%- assign lang_remove_confirm = 'ãŠæ°—ã«å…¥ã‚Šã‹ã‚‰å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ' -%}
      {%- assign lang_remove_tooltip = 'å‰Šé™¤ã™ã‚‹' -%}
      {%- assign lang_notify = 'å…¥è·é€šçŸ¥ã‚’å—ã‘å–ã‚‹' -%}
      {%- assign lang_subscribed = 'å…¥è·é€šçŸ¥ç™»éŒ²æ¸ˆã¿' -%}
      {%- assign lang_success_reg = 'å…¥è·é€šçŸ¥ã‚’ç™»éŒ²ã—ã¾ã—ãŸï¼' -%}
      {%- assign lang_success_del = 'é€šçŸ¥ç™»éŒ²ã‚’è§£é™¤ã—ã¾ã—ãŸ' -%}
      {%- assign lang_email_label = 'å…¥è·é€šçŸ¥ã‚’å—ã‘å–ã‚‹ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å…¥åŠ›' -%}
      {%- assign lang_email_placeholder = 'example@email.com' -%}
      {%- assign lang_submit = 'ç™»éŒ²ã™ã‚‹' -%}
      {%- assign lang_email_error = 'æ­£ã—ã„ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„' -%}
      {%- assign lang_close = 'é–‰ã˜ã‚‹' -%}
      {%- assign lang_editor_msg = "ã‚¨ãƒ‡ã‚£ã‚¿ãƒ¢ãƒ¼ãƒ‰ï¼ˆå³å´ã®è¨­å®šã‹ã‚‰ã€Œãƒ€ãƒŸãƒ¼å•†å“ã‚’è¡¨ç¤ºã€ã‚’ONã«ã™ã‚‹ã¨ãƒ‡ã‚¶ã‚¤ãƒ³èª¿æ•´ãŒã§ãã¾ã™ï¼‰" -%}
      {%- assign lang_sample_product = "ã‚µãƒ³ãƒ—ãƒ«å•†å“" -%}
  {%- endcase -%}
{%- else -%}
  {%- assign lang_title = block.settings.text_title | default: 'ãŠæ°—ã«å…¥ã‚Šãƒªã‚¹ãƒˆ' -%}
  {%- assign lang_desc = block.settings.text_desc | default: 'ã‚ãªãŸãŒä¿å­˜ã—ãŸå•†å“ã®ä¸€è¦§ã§ã™' -%}
  {%- assign lang_empty = 'ãŠæ°—ã«å…¥ã‚Šã¯ã¾ã ã‚ã‚Šã¾ã›ã‚“' -%}
  {%- assign lang_loading = 'èª­ã¿è¾¼ã¿ä¸­...' -%}
  {%- assign lang_sold_out = 'å£²ã‚Šåˆ‡ã‚Œ' -%}
  {%- assign lang_remove_confirm = 'ãŠæ°—ã«å…¥ã‚Šã‹ã‚‰å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ' -%}
  {%- assign lang_remove_tooltip = 'å‰Šé™¤ã™ã‚‹' -%}
  {%- assign lang_notify = 'å…¥è·é€šçŸ¥ã‚’å—ã‘å–ã‚‹' -%}
  {%- assign lang_subscribed = 'å…¥è·é€šçŸ¥ç™»éŒ²æ¸ˆã¿' -%}
  {%- assign lang_success_reg = 'å…¥è·é€šçŸ¥ã‚’ç™»éŒ²ã—ã¾ã—ãŸï¼' -%}
  {%- assign lang_success_del = 'é€šçŸ¥ç™»éŒ²ã‚’è§£é™¤ã—ã¾ã—ãŸ' -%}
  {%- assign lang_email_label = 'å…¥è·é€šçŸ¥ã‚’å—ã‘å–ã‚‹ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å…¥åŠ›' -%}
  {%- assign lang_email_placeholder = 'example@email.com' -%}
  {%- assign lang_submit = 'ç™»éŒ²ã™ã‚‹' -%}
  {%- assign lang_email_error = 'æ­£ã—ã„ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„' -%}
  {%- assign lang_close = 'é–‰ã˜ã‚‹' -%}
  {%- assign lang_editor_msg = "ã‚¨ãƒ‡ã‚£ã‚¿ãƒ¢ãƒ¼ãƒ‰ï¼ˆå³å´ã®è¨­å®šã‹ã‚‰ã€Œãƒ€ãƒŸãƒ¼å•†å“ã‚’è¡¨ç¤ºã€ã‚’ONã«ã™ã‚‹ã¨ãƒ‡ã‚¶ã‚¤ãƒ³èª¿æ•´ãŒã§ãã¾ã™ï¼‰" -%}
  {%- assign lang_sample_product = "ã‚µãƒ³ãƒ—ãƒ«å•†å“" -%}
{%- endif -%}

<div class="wishlist-modern-container wishlist-container-{{ block.id }}">
  <header class="wishlist-header">
    <h1 class="wishlist-title">{{ lang_title | escape }}</h1>
    <div class="wishlist-guide">
      <p>{{ lang_desc | escape }}</p>
    </div>
  </header>
  <div id="wishlist-items" class="wishlist-grid-list">
    <p id="wishlist-loading-msg" class="loading-msg">{{ lang_loading }}</p>
  </div>
</div>

<div id="wishflow-toast" class="wf-toast-hidden"></div>

{%- assign t_opacity = block.settings.toast_bg_opacity | default: 85 -%}
{%- assign t_alpha = t_opacity | divided_by: 100.0 -%}
{%- assign t_bg_raw = block.settings.toast_bg_color | default: '#121212' -%}
{%- assign t_bg_rgba = t_bg_raw | color_modify: 'alpha', t_alpha -%}

{%- assign modal_bg_color = block.settings.modal_bg_color | default: '#ffffff' -%}
{%- assign modal_opacity_decimal = block.settings.modal_bg_opacity | default: 85 | divided_by: 100.0 -%}
{%- assign modal_bg_rgba = modal_bg_color | color_modify: 'alpha', modal_opacity_decimal -%}
{%- assign modal_text_color = block.settings.modal_text_color | default: '#121212' -%}
{%- assign modal_radius = block.settings.modal_radius | default: 12 -%}
{%- assign modal_btn_bg = block.settings.modal_btn_bg_color | default: '#121212' -%}
{%- assign modal_btn_text = block.settings.modal_btn_text_color | default: '#ffffff' -%}

<style>
  .wishlist-container-{{ block.id }} {
    max-width: 900px; margin: 40px auto; padding: 0 20px; color: #121212;
    --header-align: {{ block.settings.header_align }};
    --title-size: {{ block.settings.title_size }}px;
    --title-weight: {{ block.settings.title_weight }};
    --title-color: {{ block.settings.title_color }};
    --desc-size: {{ block.settings.desc_size }}px;
    --desc-weight: {{ block.settings.desc_weight }};
    --desc-color: {{ block.settings.desc_color }};
    --name-size: {{ block.settings.custom_name_text_size }}px;
    --name-weight: {{ block.settings.name_weight }};
    --price-size: {{ block.settings.custom_price_text_size }}px;
    --price-weight: {{ block.settings.price_weight }};
    --card-notify-bg: {{ block.settings.card_notify_bg_color }};
    --card-notify-text: {{ block.settings.card_notify_text_color }};
    --card-notify-border: {{ block.settings.card_notify_border_color }};
  }
  .wishlist-container-{{ block.id }} .wishlist-header { text-align: var(--header-align); margin-bottom: 30px; }
  .wishlist-container-{{ block.id }} .wishlist-title { font-size: var(--title-size); font-weight: var(--title-weight); color: var(--title-color); letter-spacing: 0.05em; text-transform: uppercase; margin: 0 0 10px 0; }
  .wishlist-container-{{ block.id }} .wishlist-guide p { font-size: var(--desc-size); font-weight: var(--desc-weight); color: var(--desc-color); margin: 0; }
  .wishlist-grid-list { display: grid; grid-template-columns: repeat(2, 1fr); gap: 30px 20px; border-top: 1px solid #e8e8e8; padding-top: 30px; min-height: 200px; }
  @media (min-width: 768px) { .wishlist-grid-list { grid-template-columns: repeat(4, 1fr); } }
  .wishlist-item { position: relative; display: flex; flex-direction: column; text-align: center; }
  .item-image-link { position: relative; display: block; aspect-ratio: 1/1; background: #f9f9f9; margin-bottom: 12px; overflow: hidden; border: 1px solid #eee; }
  .item-image { width: 100%; height: 100%; object-fit: cover; transition: transform 0.3s ease; }
  .sold-out-badge { position: absolute; bottom: 0; right: 0; background: rgba(0, 0, 0, 0.7); color: #fff; padding: 4px 8px; font-size: 10px; font-weight: bold; }
  .wishlist-container-{{ block.id }} .item-name { font-size: var(--name-size); font-weight: var(--name-weight); text-decoration: none; color: inherit; margin-bottom: 4px; display: block; line-height: 1.4; }
  .wishlist-container-{{ block.id }} .item-price { font-size: var(--price-size); font-weight: var(--price-weight); color: #666; }
  .remove-btn { position: absolute; top: 5px; right: 5px; background: rgba(255,255,255,0.9); border: 1px solid #ddd; width: 32px; height: 32px; border-radius: 50%; cursor: pointer; z-index: 2; display: flex; align-items: center; justify-content: center; font-size: 18px; transition: 0.2s; color: #666; }
  .notify-btn-small { margin-top: 8px; width: 100%; padding: 8px; background: var(--card-notify-bg); border: 1px solid var(--card-notify-border); color: var(--card-notify-text); font-size: 12px; font-weight: bold; border-radius: 4px; cursor: pointer; transition: 0.2s; }
  .notify-btn-small.registered { background: #eee !important; border-color: #ccc !important; color: #888 !important; }

  #wishflow-toast {
    position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%);
    background-color: {{ t_bg_rgba }};
    {% if block.settings.toast_glass_effect %}
    backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px);
    {% endif %}
    color: {{ block.settings.toast_text_color | default: '#ffffff' }};
    padding: 12px 24px; border-radius: 30px;
    font-size: 14px; font-weight: bold; z-index: 100000; box-shadow: 0 4px 15px rgba(0,0,0,0.3);
    transition: all 0.3s ease; opacity: 1;
  }
  .wf-toast-hidden { opacity: 0 !important; bottom: 10px !important; pointer-events: none; }
</style>

<script>
  (function() {
    const STORAGE_KEY = 'wishflow_guest_list';
    const NOTIFY_STORAGE_KEY = 'restock_notification_list';
    const CUSTOMER_ID = "{{ customer.id }}";
    const CONTAINER = document.getElementById('wishlist-items');
    const LOADING_MSG = document.getElementById('wishlist-loading-msg');

    function getGuestList() { try { return JSON.parse(localStorage.getItem(STORAGE_KEY)) || []; } catch (e) { return []; } }
    function setGuestList(list) { localStorage.setItem(STORAGE_KEY, JSON.stringify(list)); }
    function getNotifyList() { try { return JSON.parse(localStorage.getItem(NOTIFY_STORAGE_KEY)) || []; } catch (e) { return []; } }

    function showToast(message) {
      const toast = document.getElementById('wishflow-toast');
      toast.textContent = message;
      toast.classList.remove('wf-toast-hidden');
      setTimeout(() => { toast.classList.add('wf-toast-hidden'); }, 3000);
    }

    async function init() {
      // ğŸŒŸ ã‚¨ãƒ‡ã‚£ã‚¿ç”»é¢ã§ã®ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼åˆ¶å¾¡ï¼ˆãƒ€ãƒŸãƒ¼å•†å“ã®è¡¨ç¤ºã‚‚å¤šè¨€èªåŒ–ï¼ï¼‰
      {% if request.design_mode %}
        {% if block.settings.show_card_preview %}
          const dummyHtml = `
            <div class="wishlist-item"><button class="remove-btn">Ã—</button><a href="#" class="item-image-link"><img src="//cdn.shopify.com/s/images/themes/product-1.png" class="item-image" alt="Sample"><span class="sold-out-badge">{{ lang_sold_out }}</span></a><div class="wishlist-item-info"><a href="#" class="item-name">{{ lang_sample_product }} A</a><span class="item-price">Â¥5,000</span><button class="notify-btn-small">{{ lang_notify }}</button></div></div>
            <div class="wishlist-item"><button class="remove-btn">Ã—</button><a href="#" class="item-image-link"><img src="//cdn.shopify.com/s/images/themes/product-2.png" class="item-image" alt="Sample"></a><div class="wishlist-item-info"><a href="#" class="item-name">{{ lang_sample_product }} B</a><span class="item-price">Â¥12,000</span></div></div>
            <div class="wishlist-item"><button class="remove-btn">Ã—</button><a href="#" class="item-image-link"><img src="//cdn.shopify.com/s/images/themes/product-3.png" class="item-image" alt="Sample"><span class="sold-out-badge">{{ lang_sold_out }}</span></a><div class="wishlist-item-info"><a href="#" class="item-name">{{ lang_sample_product }} C</a><span class="item-price">Â¥8,500</span><button class="notify-btn-small registered">{{ lang_subscribed }}</button></div></div>
            <div class="wishlist-item"><button class="remove-btn">Ã—</button><a href="#" class="item-image-link"><img src="//cdn.shopify.com/s/images/themes/product-4.png" class="item-image" alt="Sample"></a><div class="wishlist-item-info"><a href="#" class="item-name">{{ lang_sample_product }} D</a><span class="item-price">Â¥3,200</span></div></div>
          `;
          CONTAINER.innerHTML = dummyHtml;
          return;
        {% else %}
          if (LOADING_MSG) LOADING_MSG.innerText = "{{ lang_editor_msg }}";
          return;
        {% endif %}
      {% endif %}

      let wishlist = [];
      const metaRaw = {{ customer.metafields.custom.wishlist.value | json }};
      if (metaRaw) { try { wishlist = [...wishlist, ...(Array.isArray(metaRaw) ? metaRaw : JSON.parse(metaRaw))]; } catch(e){} }
      wishlist = [...new Set([...wishlist, ...getGuestList()])].filter(h => h);

      if (wishlist.length === 0) { LOADING_MSG.innerText = "{{ lang_empty }}"; return; }
      const notifyList = getNotifyList();
      const rootPath = window.Shopify ? window.Shopify.routes.root : '/';
      
      const products = await Promise.all(wishlist.map(async (handle) => {
        try {
          const res = await fetch(`${rootPath}products/${handle.trim()}.js`.replace('//', '/'));
          return res.ok ? await res.json() : null;
        } catch (err) { return null; }
      }));

      let html = '';
      for (const product of products) {
        if (!product) continue;
        const imgUrl = product.featured_image || '//cdn.shopify.com/s/images/themes/product-1.png';
        const price = (product.price / 100).toLocaleString();
        
        let badgeHtml = '', notifyBtnHtml = '';
        if (!product.available) {
          badgeHtml = `<span class="sold-out-badge">{{ lang_sold_out }}</span>`;
          const isRegistered = notifyList.some(key => key.includes(product.handle) || key.includes(product.variants[0].id.toString()));
          const btnText = isRegistered ? "{{ lang_subscribed }}" : "{{ lang_notify }}";
          const btnClass = isRegistered ? "notify-btn-small registered" : "notify-btn-small";
          notifyBtnHtml = `<button class="${btnClass}" id="list-notify-${product.handle}" onclick="window.requestNotifyFromList('${product.handle}', ${product.variants[0].id})">${btnText}</button>`;
        }
        html += `<div class="wishlist-item" id="item-${product.handle}"><button class="remove-btn" onclick="removeWish('${product.handle}')">Ã—</button><a href="${product.url}" class="item-image-link"><img src="${imgUrl}" class="item-image" alt="${product.title}">${badgeHtml}</a><div class="wishlist-item-info"><a href="${product.url}" class="item-name">${product.title}</a><span class="item-price">Â¥${price}</span>${notifyBtnHtml}</div></div>`;
      }
      if (html) { CONTAINER.innerHTML = html; } else { LOADING_MSG.innerText = "{{ lang_empty }}"; }
    }

    async function sendNotifyRequestList(handle, variantId, email) {
      const btn = document.getElementById(`list-notify-${handle}`);
      if (!btn) return;
      const isRegistered = btn.classList.contains('registered');
      const rootPath = window.Shopify ? window.Shopify.routes.root : '/';

      let list = getNotifyList();
      const storageKey = `${handle}-${variantId}`;
      if (isRegistered) {
        list = list.filter(i => i !== storageKey && i !== handle);
        btn.textContent = "{{ lang_notify }}"; btn.classList.remove('registered');
        showToast("{{ lang_success_del }}");
      } else {
        if (!list.includes(storageKey)) list.push(storageKey);
        btn.textContent = "{{ lang_subscribed }}"; btn.classList.add('registered');
        showToast("{{ lang_success_reg }}");
      }
      localStorage.setItem(NOTIFY_STORAGE_KEY, JSON.stringify(list));

      try {
        await fetch(`${rootPath}apps/wishlist/notify`.replace('//', '/'), {
          method: 'POST', headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ productHandle: handle, variantId: variantId, customerEmail: email, actionType: isRegistered ? 'delete' : 'create', referrer: window.location.href })
        });
      } catch (e) { console.error("Sync failed:", e); }
    }

    window.removeWish = async function(handle) {
      if (!confirm("{{ lang_remove_confirm }}")) return;
      const el = document.getElementById(`item-${handle}`);
      if (el) el.remove();
      let list = getGuestList().filter(h => h !== handle);
      setGuestList(list);
      if (CUSTOMER_ID) {
        try {
          const rootPath = window.Shopify ? window.Shopify.routes.root : '/';
          await fetch(`${rootPath}apps/wishlist/api/wishlist`.replace('//', '/'), {
            method: 'POST', headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ customerId: CUSTOMER_ID, productHandle: handle, mode: 'delete' })
          });
        } catch(e) { console.error(e); }
      }
    };

    window.requestNotifyFromList = async function(handle, variantId) {
      let email = "{{ customer.email }}" || localStorage.getItem('wishflow_guest_email');
      if (!email) { showEmailModal((inputEmail) => sendNotifyRequestList(handle, variantId, inputEmail)); } 
      else { sendNotifyRequestList(handle, variantId, email); }
    };

    function showEmailModal(callback) {
      const existing = document.getElementById('wishlist-custom-alert');
      if (existing) existing.remove();
      const savedEmail = localStorage.getItem('wishflow_guest_email') || '';
      
      const glassEffect = {% if block.settings.modal_glass_effect %}'backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px);'{% else %}''{% endif %};
      const bgColor = '{{ modal_bg_rgba }}';
      const textColor = '{{ modal_text_color }}';
      const radius = '{{ modal_radius }}px';
      const btnBg = '{{ modal_btn_bg }}';
      const btnText = '{{ modal_btn_text }}';

      const html = `
        <div id="wishlist-custom-alert" style="position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: rgba(0,0,0,0.4); display: flex; align-items: center; justify-content: center; z-index: 99999;">
          <div style="background-color: ${bgColor}; color: ${textColor}; border-radius: ${radius}; ${glassEffect} padding: 24px; width: 90%; max-width: 320px; text-align: center; box-shadow: 0 10px 30px rgba(0,0,0,0.2);">
            <div class="wishlist-email-form">
              <label style="font-weight:bold; margin-bottom:4px; display:block; text-align:left;">{{ lang_email_label }}</label>
              <input type="email" id="wishlist-guest-email-list" style="width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; color: #333;" value="${savedEmail}" placeholder="{{ lang_email_placeholder }}">
              <div id="wishlist-email-error-list" style="color:red; font-size:12px; display:none; margin-top:5px;"></div>
              <button id="wishlist-email-submit-list" style="width: 100%; padding: 10px; background-color: ${btnBg}; color: ${btnText}; border: none; border-radius: 4px; font-weight: bold; cursor: pointer; margin-top: 10px;">{{ lang_submit }}</button>
              <button onclick="document.getElementById('wishlist-custom-alert').remove()" style="margin-top:10px; background:none; border:none; color:inherit; cursor:pointer; opacity:0.7;">{{ lang_close }}</button>
            </div>
          </div>
        </div>`;
      document.body.insertAdjacentHTML('beforeend', html);
      document.getElementById('wishlist-email-submit-list').onclick = function() {
        const email = document.getElementById('wishlist-guest-email-list').value.trim();
        if (!email || !email.includes('@')) { 
          const err = document.getElementById('wishlist-email-error-list');
          err.innerText = "{{ lang_email_error }}"; err.style.display = 'block'; return; 
        }
        localStorage.setItem('wishflow_guest_email', email);
        callback(email); document.getElementById('wishlist-custom-alert').remove();
      };
    }

    document.addEventListener("DOMContentLoaded", init);
    window.addEventListener('wishflow:updated', init);

    {% if request.design_mode %}
      {% if block.settings.show_email_preview %}
        setTimeout(() => { 
          if(typeof showEmailModal === 'function') showEmailModal(() => {}); 
        }, 500);
      {% endif %}
      {% if block.settings.show_toast_preview %}
        setTimeout(() => { 
          const t = document.getElementById('wishflow-toast');
          if(t) {
            t.textContent = "âœ“ ãƒ‡ã‚¶ã‚¤ãƒ³ç¢ºèªç”¨ã®ãƒˆãƒ¼ã‚¹ãƒˆã§ã™";
            t.classList.remove('wf-toast-hidden');
          }
        }, 1000);
      {% endif %}
    {% endif %}

  })();
</script>

{% schema %}
{
  "name": "t:account.name",
  "target": "section",
  "settings": [
    { "type": "header", "content": "t:account.header_text" },
    { "type": "text", "id": "text_title", "label": "t:account.title", "default": "t:account.default_title" },
    { "type": "text", "id": "text_desc", "label": "t:account.desc", "default": "t:account.default_desc" },
    { "type": "select", "id": "header_align", "label": "t:account.align", "options": [
      { "value": "left", "label": "t:account.left" },
      { "value": "center", "label": "t:account.center" },
      { "value": "right", "label": "t:account.right" }
    ], "default": "center" },
    { "type": "color", "id": "title_color", "label": "t:account.title_color", "default": "#121212" },
    { "type": "color", "id": "desc_color", "label": "t:account.desc_color", "default": "#666666" },
    { "type": "header", "content": "t:account.header_design" },
    { "type": "range", "id": "title_size", "label": "t:account.title_size", "min": 16, "max": 40, "step": 1, "unit": "px", "default": 24 },
    { "type": "select", "id": "title_weight", "label": "t:account.title_weight", "options": [
      { "value": "normal", "label": "t:account.normal" },
      { "value": "bold", "label": "t:account.bold" }
    ], "default": "normal" },

    { "type": "header", "content": "t:account.header_card" },
    { "type": "checkbox", "id": "show_card_preview", "label": "t:account.show_card_preview", "default": false },
    { "type": "range", "id": "custom_name_text_size", "label": "t:account.custom_name_text_size", "min": 10, "max": 24, "step": 1, "unit": "px", "default": 14 },
    { "type": "select", "id": "name_weight", "label": "t:account.name_weight", "options": [ { "value": "normal", "label": "t:account.normal" }, { "value": "bold", "label": "t:account.bold" } ], "default": "bold" },
    { "type": "range", "id": "custom_price_text_size", "label": "t:account.custom_price_text_size", "min": 10, "max": 24, "step": 1, "unit": "px", "default": 13 },
    { "type": "select", "id": "price_weight", "label": "t:account.price_weight", "options": [ { "value": "normal", "label": "t:account.normal" }, { "value": "bold", "label": "t:account.bold" } ], "default": "normal" },
    { "type": "color", "id": "card_notify_bg_color", "label": "t:account.card_notify_bg_color", "default": "#ffffff" },
    { "type": "color", "id": "card_notify_text_color", "label": "t:account.card_notify_text_color", "default": "#d72c0d" },
    { "type": "color", "id": "card_notify_border_color", "label": "t:account.card_notify_border_color", "default": "#d72c0d" },

    { "type": "header", "content": "t:account.header_email_design" },
    { "type": "checkbox", "id": "show_email_preview", "label": "t:account.show_email_preview", "default": false },
    { "type": "checkbox", "id": "modal_glass_effect", "label": "t:account.modal_glass_effect", "default": true },
    { "type": "color", "id": "modal_bg_color", "label": "t:account.modal_bg_color", "default": "#ffffff" },
    { "type": "range", "id": "modal_bg_opacity", "label": "t:account.modal_bg_opacity", "min": 0, "max": 100, "step": 1, "unit": "%", "default": 85 },
    { "type": "color", "id": "modal_text_color", "label": "t:account.modal_text_color", "default": "#121212" },
    { "type": "range", "id": "modal_radius", "label": "t:account.modal_radius", "min": 0, "max": 50, "step": 1, "unit": "px", "default": 12 },
    { "type": "color", "id": "modal_btn_bg_color", "label": "t:account.modal_btn_bg_color", "default": "#121212" },
    { "type": "color", "id": "modal_btn_text_color", "label": "t:account.modal_btn_text_color", "default": "#ffffff" },

    { "type": "header", "content": "t:account.header_toast" },
    { "type": "checkbox", "id": "show_toast_preview", "label": "t:account.show_toast_preview", "default": false },
    { "type": "checkbox", "id": "toast_glass_effect", "label": "t:account.toast_glass_effect", "default": true },
    { "type": "color", "id": "toast_bg_color", "label": "t:account.toast_bg_color", "default": "#121212" },
    { "type": "range", "id": "toast_bg_opacity", "label": "t:account.toast_bg_opacity", "min": 0, "max": 100, "step": 1, "unit": "%", "default": 85 },
    { "type": "color", "id": "toast_text_color", "label": "t:account.toast_text_color", "default": "#ffffff" }
  ] 
}
{% endschema %}